---
/**
 * CopyCodeButton.astro
 * 
 * A headless component that injects a copy button into all code blocks
 * on the page. It uses a template to render the button element safely.
 */
---

<template id="copy-code-button-template">
  <div class="copy-code-btn absolute top-3 right-3 z-10">
    <button class="flex items-center justify-center p-2 rounded-md bg-background/50 hover:bg-background/80 text-muted-foreground hover:text-foreground border border-border/50 transition-all duration-200 backdrop-blur-sm opacity-0 group-hover:opacity-100 focus:opacity-100" aria-label="Copy code">
      <!-- Copy Icon -->
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy icon-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
      <!-- Check Icon (Hidden by default) -->
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check icon-check hidden"><path d="M20 6 9 17l-5-5"/></svg>
    </button>
  </div>
</template>

<script>
  function addCopyButtons() {
    const template = document.getElementById('copy-code-button-template');
    if (!template) return;

    const codeBlocks = document.querySelectorAll('pre');

    codeBlocks.forEach((pre) => {
      if (pre.querySelector('.copy-code-btn')) return;

      if (getComputedStyle(pre).position === 'static') {
        pre.style.position = 'relative';
      }
      pre.classList.add('group');

      // Clone template
      // Cast to HTMLTemplateElement to make TS happy
      const content = (template as HTMLTemplateElement).content;
      const clone = content.cloneNode(true) as DocumentFragment;
      
      const button = clone.querySelector('button');
      const iconCopy = clone.querySelector('.icon-copy');
      const iconCheck = clone.querySelector('.icon-check');

      if (!button || !iconCopy || !iconCheck) return;

      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        const text = code ? code.innerText : pre.innerText;

        try {
          await navigator.clipboard.writeText(text);

          // Show feedback
          iconCopy.classList.add('hidden');
          iconCheck.classList.remove('hidden');
          button.classList.add('text-emerald-500', 'border-emerald-500/50');
          button.classList.remove('text-muted-foreground');

          setTimeout(() => {
            iconCopy.classList.remove('hidden');
            iconCheck.classList.add('hidden');
            button.classList.remove('text-emerald-500', 'border-emerald-500/50');
            button.classList.add('text-muted-foreground');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });

      pre.appendChild(clone);
    });
  }

  // Run on initial load
  addCopyButtons();

  // Run on view transitions
  document.addEventListener('astro:page-load', addCopyButtons);
</script>