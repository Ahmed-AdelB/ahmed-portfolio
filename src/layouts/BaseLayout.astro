---
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
import '../styles/terminal.css';
import Schema from '../components/seo/Schema.astro';
import CommandPalette from '../components/features/CommandPalette';
import BackToTop from '../components/features/BackToTop.astro';
import CopyCodeButton from '../components/features/CopyCodeButton.astro';
// Self-hosted fonts
import '@fontsource/space-grotesk/300.css';
import '@fontsource/space-grotesk/400.css';
import '@fontsource/space-grotesk/500.css';
import '@fontsource/space-grotesk/600.css';
import '@fontsource/space-grotesk/700.css';
import '@fontsource/jetbrains-mono/400.css';
import '@fontsource/jetbrains-mono/500.css';
import '@fontsource/jetbrains-mono/600.css';

interface Props {
  title: string;
  description: string;
  image?: string;
  article?: boolean;
}

const {
  title,
  description,
  image = '/og-default.svg',
  article = false,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.site);
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- Color scheme for browser UI -->
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0a0a0a" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <Schema title={title} description={description} article={article} image={socialImageURL.href} />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={article ? 'article' : 'website'} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={`${title} - Ahmed Adel Portfolio`} />
    <meta property="og:site_name" content="Ahmed Adel" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@ahmedaderai" />
    <meta name="twitter:creator" content="@ahmedaderai" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageURL} />
    <meta name="twitter:image:alt" content={`${title} - Ahmed Adel Portfolio`} />

    <!-- SEO meta component slot -->
    <slot name="head" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- RSS Feed -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Ahmed Adel - Blog RSS Feed"
      href="/rss.xml"
    />

    <!-- Theme + terminal detection script (FOUC prevention) -->
    <script is:inline>
      (function() {
        const root = document.documentElement;
        let terminalEnabled = false;

        try {
          const storedTerminal = localStorage.getItem('terminal-mode');
          terminalEnabled = storedTerminal === '1' || storedTerminal === 'true';
        } catch (error) {
          terminalEnabled = false;
        }

        if (terminalEnabled) {
          root.setAttribute('data-terminal', 'true');
          root.style.backgroundColor = '#000000';
          root.style.color = '#00ff00';
          root.style.colorScheme = 'dark';
        }

        const getThemePreference = () => {
          if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
            return localStorage.getItem('theme');
          }
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        const theme = getThemePreference();
        const isDark = theme === 'dark';

        root.classList.toggle('dark', isDark);

        if (!terminalEnabled) {
          root.style.colorScheme = isDark ? 'dark' : 'light';
        }

        // Prevent FOUC by setting initial background
        if (isDark && !terminalEnabled) {
          root.style.backgroundColor = '#0a0a0a';
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          if (!localStorage.getItem('theme')) {
            const newTheme = e.matches ? 'dark' : 'light';
            root.classList.toggle('dark', e.matches);
            if (!root.hasAttribute('data-terminal')) {
              root.style.colorScheme = newTheme;
            }
          }
        });
      })();
    </script>

    <!-- View Transitions API -->
    <ViewTransitions fallback="swap" />
  </head>

  <body
    class="min-h-screen bg-background text-foreground font-sans antialiased transition-colors duration-300"
  >
    <!-- Skip Links (WCAG 2.4.1) -->
    <div class="skip-links">
      <a
        href="#main-content"
        class="skip-link sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-emerald-600 focus:text-white focus:rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 focus:font-medium"
      >
        Skip to main content
      </a>
      <a
        href="#main-nav"
        class="skip-link sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-48 focus:z-50 focus:px-4 focus:py-2 focus:bg-emerald-600 focus:text-white focus:rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 focus:font-medium"
      >
        Skip to navigation
      </a>
    </div>

    <!-- Scroll Progress Indicator -->
    <div
      id="scroll-progress"
      class="fixed top-0 left-0 h-1 bg-gradient-to-r from-emerald-500 to-cyan-500 z-[9999] transition-all duration-75"
      style="width: 0%"
      role="progressbar"
      aria-label="Reading progress"
      aria-valuenow="0"
      aria-valuemin="0"
      aria-valuemax="100"
    ></div>

    <!-- Page content slot wrapped in main -->
    <main id="main-content" tabindex="-1" class="outline-none">
      <slot />
    </main>

    <!-- Command Palette (Cmd+K) -->
    <CommandPalette client:load />
    
    <!-- Back to Top Button -->
    <BackToTop />
    <CopyCodeButton />

    <!-- Theme transition handler for View Transitions -->
    <script>
      document.addEventListener('astro:after-swap', () => {
        const root = document.documentElement;
        const theme = localStorage.getItem('theme') ||
          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        const isDark = theme === 'dark';

        root.classList.toggle('dark', isDark);

        const terminalValue = localStorage.getItem('terminal-mode');
        const terminalEnabled = terminalValue === '1' || terminalValue === 'true';

        if (terminalEnabled) {
          root.setAttribute('data-terminal', 'true');
          root.style.backgroundColor = '#000000';
          root.style.color = '#00ff00';
          root.style.colorScheme = 'dark';
        } else {
          root.removeAttribute('data-terminal');
          root.style.removeProperty('background-color');
          root.style.removeProperty('color');
          root.style.colorScheme = isDark ? 'dark' : 'light';
        }
      });
    </script>

    <!-- Scroll Progress Indicator Script -->
    <script>
      function initScrollProgress() {
        const progressBar = document.getElementById('scroll-progress');
        if (!progressBar) return;

        let ticking = false;

        const updateProgress = () => {
          const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
          if (scrollHeight <= 0) {
            progressBar.style.width = '0%';
            return;
          }

          const progress = Math.min(100, (window.scrollY / scrollHeight) * 100);
          progressBar.style.width = `${progress}%`;
          progressBar.setAttribute('aria-valuenow', String(Math.round(progress)));
        };

        window.addEventListener('scroll', () => {
          if (!ticking) {
            window.requestAnimationFrame(() => {
              updateProgress();
              ticking = false;
            });
            ticking = true;
          }
        }, { passive: true });

        // Initial update
        updateProgress();
      }

      // Initialize on load and after view transitions
      initScrollProgress();
      document.addEventListener('astro:page-load', initScrollProgress);
    </script>
  </body>
</html>
