---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { ContributionTimeline, type Contribution } from "../components/features/ContributionTimeline";

const rawContributions = await getCollection("contributions");

// Transform to match the interface and ensure serializable dates
const contributions: Contribution[] = rawContributions.map(c => ({
  project: c.data.project,
  title: c.data.title,
  type: c.data.type,
  pr_url: c.data.pr_url,
  impact: c.data.impact,
  date: c.data.date.toISOString(), // Serialize for React prop
  status: c.data.status,
  description: c.data.description,
  additions: c.data.additions,
  deletions: c.data.deletions,
}));

// Sort by date (newest first)
contributions.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const totalPRs = contributions.length;
const projectsCount = new Set(contributions.map((c) => c.project)).size;
---

<BaseLayout
  title="Open Source Contributions | Ahmed Adel"
  description="A timeline of my open source contributions to projects like pip, Pydantic, and more."
>
  <div class="container mx-auto px-4 py-16 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-4xl">
      <header class="mb-12 text-center">
        <h1
          class="mb-4 text-4xl font-extrabold tracking-tight text-gray-900 dark:text-white sm:text-5xl"
        >
          Open Source Contributions
        </h1>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Giving back to the community, one Pull Request at a time.
        </p>
      </header>

      <!-- Stats Grid -->
      <div class="mb-12 grid grid-cols-2 gap-4 sm:grid-cols-3">
        <dl
          class="rounded-xl border border-gray-200 bg-white p-6 text-center shadow-sm dark:border-gray-700 dark:bg-gray-800"
        >
          <dt class="truncate text-sm font-medium text-gray-500 dark:text-gray-400">Total PRs</dt>
          <dd class="mt-2 text-3xl font-semibold text-gray-900 dark:text-white">{totalPRs}</dd>
        </dl>
        <dl
          class="rounded-xl border border-gray-200 bg-white p-6 text-center shadow-sm dark:border-gray-700 dark:bg-gray-800"
        >
          <dt class="truncate text-sm font-medium text-gray-500 dark:text-gray-400">
            Projects Contributed To
          </dt>
          <dd class="mt-2 text-3xl font-semibold text-gray-900 dark:text-white">
            {projectsCount}
          </dd>
        </dl>
        <dl
          class="col-span-2 rounded-xl border border-gray-200 bg-white p-6 text-center shadow-sm sm:col-span-1 dark:border-gray-700 dark:bg-gray-800"
        >
          <dt class="truncate text-sm font-medium text-gray-500 dark:text-gray-400">
            Impact
          </dt>
          <dd class="mt-2 text-3xl font-semibold text-gray-900 dark:text-white">
            High
          </dd>
        </dl>
      </div>

      <!-- Interactive Timeline -->
      <ContributionTimeline client:visible data={contributions} />

    </div>
  </div>
</BaseLayout>